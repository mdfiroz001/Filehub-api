<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="description" content="FileHub Premium - Secure File Storage & Sharing Platform">
    <meta name="keywords" content="file storage, secure downloads, premium resources, cloud sharing, file manager">
    <meta name="author" content="FileHub Team">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://file-hubs.vercel.app/">
    <meta property="og:title" content="FileHub Premium - Secure Storage & Sharing">
    <meta property="og:description" content="Access and manage your premium files with FileHub. Fast, secure, and powered by AI.">
    <meta property="og:image" content="https://iili.io/fY4mez7.jpg">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://file-hubs.vercel.app/">
    <meta property="twitter:title" content="FileHub Premium">
    <meta property="twitter:description" content="The ultimate platform for secure file management and premium downloads.">
    <meta property="twitter:image" content="https://iili.io/fY4mez7.jpg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <meta name="google-site-verification" content="bkC0hqaxdTEmhPnCqJthesPf0tTlu42qHmNRGauItew" />
    <link rel="icon" type="image/png" href="https://iili.io/fY4mez7.jpg">
    <link rel="apple-touch-icon" href="https://iili.io/fY4mez7.jpg">
    <link rel="manifest" href="/manifest.json">
    <title>FileHub - Secure File Sharing</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    
    <script>
        (function() {
            try {
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
            } catch(e) {}
        })();
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <style>
        :root {
            --primary: #4f46e5;
            --primary-soft: #e0e7ff;
            --primary-glow: rgba(79, 70, 229, 0.5);
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --nav-height: 60px;
            --unread-bg: #fee2e2;
            --unread-border: #fca5a5;
            --chat-user-bg: #4f46e5;
            --chat-user-text: #ffffff;
            --chat-ai-bg: #f1f5f9;
            --chat-ai-text: #0f172a;
            --skeleton-base: #e2e8f0;
            --skeleton-highlight: #f1f5f9;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        [data-theme="dark"] {
            --primary: #818cf8;
            --primary-soft: #1e293b;
            --primary-glow: rgba(129, 140, 248, 0.5);
            --bg: #0f172a;
            --surface: #1e293b;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --border: #334155;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --unread-bg: #450a0a;
            --unread-border: #7f1d1d;
            --chat-user-bg: #818cf8;
            --chat-user-text: #0f172a;
            --chat-ai-bg: #334155;
            --chat-ai-text: #f8fafc;
            --skeleton-base: #1e293b;
            --skeleton-highlight: #334155;
        }

        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        input, textarea, .profile-avatar, .brand-img, .ai-avatar, .ai-loading-img {
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
            user-select: auto;
        }

        body { 
            background: var(--bg); color: var(--text-main); font-family: 'Inter', sans-serif; 
            margin: 0; padding: 0; -webkit-font-smoothing: antialiased; 
            overflow-x: hidden; padding-bottom: calc(var(--nav-height) + 30px);
            transition: background 0.3s ease, color 0.3s ease;
            touch-action: pan-x pan-y;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, var(--skeleton-base) 25%, var(--skeleton-highlight) 50%, var(--skeleton-base) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
        }
        .sk-img { width: 100%; aspect-ratio: 16/9; border-radius: 12px; margin-bottom: 10px; }
        .sk-title { height: 20px; width: 80%; margin-bottom: 8px; }
        .sk-text { height: 14px; width: 60%; }
        .sk-avatar { width: 38px; height: 38px; border-radius: 50%; }
        .sk-row { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
        
        header { 
            background: var(--surface); border-bottom: 1px solid var(--border); 
            position: sticky; top: 0; z-index: 1000; height: 65px; display: flex; align-items: center;
        }
        .header-content { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 20px; position: relative; height: 100%; display: flex; align-items: center; }
        .header-main { width: 100%; display: flex; justify-content: space-between; align-items: center; }
        
        .brand { display: flex; align-items: center; gap: 10px; text-decoration: none; cursor: pointer; }
        .brand-img { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; border: 2px solid var(--surface); box-shadow: 0 0 0 2px var(--primary-soft); }
        .brand-text { font-family: 'Outfit', sans-serif; font-size: 1.3rem; font-weight: 700; color: var(--text-main); }

        .header-actions { display: flex; align-items: center; gap: 4px; }
        .icon-btn { background: transparent; border: none; padding: 8px; border-radius: 50%; color: var(--text-sub); display: flex; cursor: pointer; transition: 0.2s; align-items: center; justify-content: center; position: relative; }
        .icon-btn:hover { background: var(--bg); color: var(--text-main); }
        .icon-btn svg { width: 22px; height: 22px; }
        .ai-icon-img { width: 26px; height: 26px; border-radius: 50%; object-fit: contain; }
        
        .notif-badge {
            position: absolute; top: 5px; right: 5px;
            background: #ef4444; color: white;
            font-size: 0.65rem; font-weight: 700;
            width: 16px; height: 16px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--surface);
            display: none;
        }
        .notif-badge.active { display: flex; }

        .search-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--surface); display: flex; align-items: center; padding: 0 15px; transform: scaleX(0); transform-origin: right; transition: transform 0.3s; z-index: 10; box-sizing: border-box; }
        .search-overlay.active { transform: scaleX(1); }
        .search-box-wrapper { flex: 1; display: flex; align-items: center; height: 40px; border: 1.5px solid var(--border); border-radius: 50px; background: var(--bg); padding: 0 5px; }
        .search-input { flex: 1; border: none; background: transparent; padding: 0 5px; color: var(--text-main); outline: none; }
        .search-back-btn, .search-clear-btn { background: none; border: none; color: var(--text-sub); width: 35px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .search-clear-btn { visibility: hidden; } .search-clear-btn.visible { visibility: visible; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        .bottom-sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            opacity: 0; visibility: hidden; transition: 0.3s;
        }
        .bottom-sheet-overlay.active { opacity: 1; visibility: visible; }
        
        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: 80vh; max-height: 95vh;
            background: var(--surface);
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
            z-index: 2001;
            transform: translateY(100%); 
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), height 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column;
            will-change: transform, height;
        }
        .bottom-sheet.active { transform: translateY(0); }
        
        .bottom-sheet.expanded {
            height: 100% !important;
            max-height: 100% !important;
            border-radius: 0;
        }
        
        .sheet-header {
            padding: 15px 20px; border-bottom: 1px solid var(--border);
            display: grid; 
            grid-template-columns: 40px 1fr 40px;
            align-items: center;
            flex-shrink: 0;
        }
        
        .sheet-title { 
            font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 1.2rem; 
            text-align: center; justify-self: center;
        }
        
        .sheet-btn {
            background: none; border: none; cursor: pointer; color: var(--text-sub);
            padding: 5px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .sheet-btn:hover { background: var(--bg); color: var(--text-main); }
        .sheet-left-btn { visibility: visible; opacity: 1; }

        .sheet-body { flex: 1; overflow-y: auto; padding: 0; position: relative; display: flex; flex-direction: column; }

        .view-container { width: 100%; height: 100%; animation: fadeIn 0.3s ease; }
        .notif-list { list-style: none; padding: 0; margin: 0; }
        .notif-item {
            padding: 15px 20px; border-bottom: 1px solid var(--bg);
            cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; gap: 5px;
        }
        .notif-item:hover { background: var(--bg); }
        .notif-item.unread { background: var(--unread-bg); border-left: 4px solid var(--unread-border); }
        
        .notif-title-list {
            font-weight: 600; font-size: 0.95rem; color: var(--text-main);
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            line-height: 1.4; white-space: normal; word-break: break-word;
        }
        .notif-time { font-size: 0.75rem; color: var(--text-sub); margin-top: 4px; }

        .notif-detail-view { padding: 25px 20px; display: none; }
        .notif-detail-title {
            font-family: 'Outfit', sans-serif; font-size: 1.3rem; font-weight: 700;
            color: var(--text-main); margin-bottom: 8px; line-height: 1.3;
        }
        .notif-detail-time { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 20px; display: block; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .notif-detail-content { line-height: 1.6; color: var(--text-main); font-size: 0.95rem; }
        .notif-detail-content p { margin-bottom: 15px; }
        .notif-detail-content a { color: var(--primary); }
        .notif-detail-content img { max-width: 100%; border-radius: 8px; margin: 10px 0; }

        .chat-container {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
            background: var(--bg);
            min-height: 0;
        }
        .chat-bubble {
            max-width: 80%; padding: 12px 16px; border-radius: 16px;
            font-size: 0.95rem; line-height: 1.5; position: relative;
            word-wrap: break-word; animation: fadeIn 0.2s ease;
        }
        .chat-bubble.user {
            align-self: flex-end; background: var(--chat-user-bg); color: var(--chat-user-text);
            border-bottom-right-radius: 2px;
        }
        .chat-bubble.ai {
            align-self: flex-start; background: var(--chat-ai-bg); color: var(--chat-ai-text);
            border-bottom-left-radius: 2px; display: flex; gap: 10px;
        }
        .ai-avatar {
            width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0;
            object-fit: contain; background: white; border: 1px solid var(--border);
        }
        .ai-content { flex: 1; overflow-x: hidden; }
        
        .chat-bubble pre { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; overflow-x: auto; }
        .chat-bubble code { font-family: monospace; font-size: 0.9em; }
        .chat-bubble.ai code { color: #d63384; background: rgba(0,0,0,0.05); padding: 2px 4px; border-radius: 4px; }
        .chat-bubble.ai pre code { color: inherit; background: transparent; padding: 0; }
        [data-theme="dark"] .chat-bubble.ai code { color: #f472b6; background: rgba(255,255,255,0.1); }
        
        .chat-footer {
            padding: 10px 15px; background: var(--surface); border-top: 1px solid var(--border);
            display: flex; align-items: flex-end; gap: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            flex-shrink: 0;
        }
        .chat-input {
            flex: 1; background: var(--bg); border: 1px solid var(--border);
            border-radius: 20px; padding: 10px 15px; max-height: 100px;
            overflow-y: auto; color: var(--text-main); font-family: inherit; font-size: 1rem;
            resize: none; outline: none; transition: border-color 0.2s;
        }
        .chat-input:focus { border-color: var(--primary); }
        .chat-send-btn {
            width: 42px; height: 42px; border-radius: 50%; background: var(--primary);
            color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; flex-shrink: 0;
        }
        .chat-send-btn:hover { opacity: 0.9; transform: scale(1.05); }
        .chat-send-btn svg { width: 20px; height: 20px; fill: white; margin-left: -2px; }

        .typing-container { display: flex; align-items: center; gap: 10px; margin-top: 10px; align-self: flex-start; }
        .ai-loading-img {
            width: 30px; height: 30px; border-radius: 50%; object-fit: contain;
            border: none;
            animation: spin 2s linear infinite;
        }
        .typing-dots { display: flex; gap: 4px; align-items: center; height: 30px; }
        .dot { width: 6px; height: 6px; background: var(--text-sub); border-radius: 50%; animation: wave 1.3s linear infinite; }
        .dot:nth-child(2) { animation-delay: -1.1s; }
        .dot:nth-child(3) { animation-delay: -0.9s; }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes wave { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }
        @keyframes fadeIn { from{opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);} }

        .carousel-wrap { width: 100%; aspect-ratio: 16/9; margin-bottom: 20px; border-radius: 16px; overflow: hidden; position: relative; box-shadow: var(--shadow-md); background: var(--surface); }
        .carousel-inner { display: flex; height: 100%; width: 100%; transition: transform 0.5s ease-out; }
        .slide { min-width: 100%; height: 100%; position: relative; cursor: pointer; }
        .slide img { width: 100%; height: 100%; object-fit: cover; }
        .carousel-dots { display: flex; justify-content: center; gap: 6px; margin-bottom: 25px; }
        .dot-c { width: 6px; height: 6px; background: var(--border); border-radius: 50%; transition: 0.3s; }
        .dot-c.active { background: var(--primary); width: 18px; border-radius: 3px; }

        .center-eye { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%) scale(0.8); 
            width: 50px; height: 50px; 
            display: flex; align-items: center; justify-content: center; 
            opacity: 0; transition: 0.3s; 
            color: white; 
        }
        .center-eye svg { width: 40px; height: 40px; stroke-width: 2.5; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        
        .slide:hover .center-eye { opacity: 1; transform: translate(-50%,-50%) scale(1); }
        .slide-overlay { position: absolute; bottom: 0; width: 100%; padding: 20px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); color: white; opacity: 0; transform: translateY(10px); transition: 0.3s; display: flex; justify-content: space-between; align-items: flex-end; box-sizing: border-box; }
        .slide:hover .slide-overlay { opacity: 1; transform: translateY(0); }
        .slide-title { font-family: 'Outfit', sans-serif; font-size: 1.1rem; margin-bottom: 5px; }
        
        .banner-pill {
            background: var(--primary-soft); color: var(--primary);
            padding: 4px 8px; border-radius: 6px;
            font-size: 0.75rem; font-weight: 700;
            display: flex; align-items: center; gap: 4px;
        }
        .banner-pill svg { width: 14px; height: 14px; stroke-width: 2.5; }

        .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; margin-top: 10px; }
        .section-header h2 { font-family: 'Outfit', sans-serif; font-size: 1.4rem; margin: 0; color: var(--text-main); }
        .section-icon { color: var(--primary); width: 24px; height: 24px; }

        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .file-card { background: var(--surface); border-radius: 12px; box-shadow: var(--shadow-sm); overflow: hidden; cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; border: 1px solid transparent; }
        .file-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: var(--shadow-md); }
        .card-thumb { width: 100%; aspect-ratio: 16/9; object-fit: cover; background: var(--bg); transition: 0.4s; }
        .file-card:hover .card-thumb { transform: scale(1.05); }
        .card-body { padding: 15px; background: var(--surface); z-index: 1; display: flex; flex-direction: column; flex: 1; }
        .card-title { font-family: 'Outfit', sans-serif; font-weight: 600; font-size: 1rem; color: var(--text-main); margin-bottom: 8px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 2.8em; }
        
        .card-footer { 
            margin-top: auto; display: flex; justify-content: space-between; align-items: center;
            font-size: 0.8rem; color: var(--text-sub); padding-top: 12px; border-top: 1px solid var(--bg); 
        }

        .meta-pill {
            background: var(--primary-soft); color: var(--primary);
            padding: 4px 10px; border-radius: 6px;
            font-size: 0.75rem; font-weight: 600; text-transform: lowercase;
            display: flex; align-items: center; gap: 5px;
        }
        .meta-pill svg { width: 14px; height: 14px; stroke-width: 2.5; }

        .detail-wrapper { width: 100%; background: transparent; padding: 0; animation: fadeIn 0.3s ease; }
        .detail-header-block { margin: 20px 0; }
        .detail-title { font-family: 'Outfit', sans-serif; font-size: 1.4rem; color: var(--text-main); line-height: 1.3; margin: 0 0 15px 0; }
        
        .detail-meta-grid { 
            display: grid; grid-template-columns: 1fr auto 1fr; 
            width: 100%; align-items: center; gap: 10px; margin-bottom: 10px;
        }
        .meta-left { justify-self: start; }
        .meta-center { justify-self: center; }
        .meta-right { justify-self: end; }

        .detail-desc { margin-top: 25px; line-height: 1.8; color: var(--text-main); font-size: 1rem; }
        .detail-desc p { margin-bottom: 15px; }
        .detail-desc img { 
            max-width: 100%; 
            height: auto; 
            border-radius: 12px; 
            margin: 15px 0; 
            box-shadow: var(--shadow-sm);
            display: block;
        }
        .unlock-inline { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border); }
        
        .unlock-actions {
            display: flex; gap: 10px; align-items: stretch; width: 100%;
        }

        .unlock-btn { 
            flex: 1; background: var(--primary); color: white; border: none; 
            padding: 16px; border-radius: 12px; font-weight: 600; font-size: 1rem; 
            cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px;
            transition: 0.2s; box-shadow: 0 4px 12px var(--primary-glow);
            min-height: 54px; 
        }
        .unlock-btn:hover { transform: translateY(-2px); opacity: 0.95; }
        .unlock-btn:disabled { background: var(--text-sub); cursor: not-allowed; transform: none; box-shadow: none; }
        
        .copy-btn {
            background: var(--surface); color: var(--text-sub); border: 1px solid var(--border);
            border-radius: 12px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            flex-shrink: 0; transition: 0.2s;
            height: auto; 
            min-width: 54px;
            width: 54px;
        }
        .copy-btn:hover { background: var(--bg); color: var(--text-main); border-color: var(--primary); }
        .copy-btn svg { width: 28px; height: 28px; }

        /* Share Button Styles */
        .share-btn {
            background: var(--primary-soft);
            color: var(--primary);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 8px;
            flex-shrink: 0;
        }

        .share-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .share-btn i {
            font-size: 18px;
        }

        .share-btn.copied {
            background: #10b981;
            color: white;
        }

        .lightbox-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px);
            z-index: 2005; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .lightbox-overlay.active { opacity: 1; }
        .lightbox-img {
            max-width: 95%; max-height: 80vh; border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.9); transition: transform 0.3s ease;
            object-fit: contain;
        }
        .lightbox-overlay.active .lightbox-img { transform: scale(1); }
        .lightbox-close {
            position: absolute; top: 0; right: 0;
            width: 48px; height: 65px; margin-right: 15px;
            display: flex; justify-content: center; align-items: center;
            background: none; border: none; color: white;
            cursor: pointer; z-index: 2006;
        }
        .lightbox-close svg { width: 30px; height: 30px; stroke-width: 2.5; }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: var(--surface); border-top: 1px solid var(--border);
            display: grid; grid-template-columns: 1fr auto 1fr;
            align-items: center; z-index: 1001; 
            padding-bottom: env(safe-area-inset-bottom);
            box-sizing: content-box; box-shadow: none;
        }
        .nav-col { display: flex; justify-content: center; align-items: center; height: 100%; }
        .nav-item {
            background: none; border: none; cursor: pointer; color: var(--text-sub);
            padding: 10px; display: flex; flex-direction: column; align-items: center; transition: 0.3s;
        }
        .nav-item svg { width: 30px; height: 30px; stroke-width: 2; }
        .nav-item:hover { color: var(--text-main); }
        .nav-home-wrapper { position: relative; width: 60px; height: 100%; display: flex; justify-content: center; }
        .nav-home {
            position: absolute; top: -20px;
            width: 52px; height: 52px;
            background: var(--primary); color: white;
            border-radius: 50%; border: 5px solid var(--surface);
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 8px 20px var(--primary-glow);
            cursor: pointer; transition: 0.2s;
        }
        .nav-home svg { width: 28px; height: 28px; }
        .nav-home:active { transform: scale(0.95); }

        .theme-icon-svg { transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .theme-active .theme-icon-svg { transform: rotate(180deg); }
        
        .error-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 50px 20px; text-align: center;
        }
        .error-icon { width: 100px; height: 100px; color: var(--text-sub); margin-bottom: 20px; }
        .error-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; color: var(--text-main); }
        .error-btn {
            margin-top: 20px; padding: 10px 20px; background: var(--primary); color: white;
            border-radius: 8px; border: none; font-weight: 600; cursor: pointer;
        }

        .admin-badge {
            background: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 10px;
            display: none;
        }

        .upload-form, .auth-form, .edit-profile-form {
            max-width: 500px;
            margin: 0 auto;
            background: var(--surface);
            padding: 40px;
            border-radius: 24px;
            box-shadow: var(--shadow-md);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 20px;
        }

        .auth-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 10px;
        }

        .auth-subtitle {
            color: var(--text-sub);
            font-size: 1rem;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: var(--bg);
            padding: 5px;
            border-radius: 50px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }

        .auth-tab.active {
            background: var(--primary);
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .form-control {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg);
            color: var(--text-main);
            font-size: 1rem;
            transition: 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-soft);
        }

        .btn {
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            border: none;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--primary-glow);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text-main);
            width: 100%;
        }

        .btn-outline:hover {
            background: var(--bg);
            border-color: var(--primary);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .alert {
            padding: 14px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        .hidden {
            display: none;
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .gap-2 {
            gap: 8px;
        }

        .gap-4 {
            gap: 16px;
        }

        .mt-4 {
            margin-top: 16px;
        }

        .mb-4 {
            margin-bottom: 16px;
        }

        .text-center {
            text-align: center;
        }

        .text-sub {
            color: var(--text-sub);
        }

        .text-primary {
            color: var(--primary);
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .w-full {
            width: 100%;
        }

        /* Profile Page Styles */
        .profile-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .profile-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-soft) 100%);
            border-radius: 24px;
            padding: 30px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 30px;
            color: white;
            box-shadow: var(--shadow-md);
        }

        .profile-avatar-wrapper {
            position: relative;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid white;
            object-fit: cover;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: 0.2s;
        }

        .profile-avatar:hover {
            transform: scale(1.05);
        }

        .profile-avatar-edit {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: white;
            color: var(--primary);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid var(--primary);
            transition: 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .profile-avatar-edit:hover {
            transform: scale(1.1);
            background: var(--primary);
            color: white;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .profile-username {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .profile-email {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .profile-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .badge {
            padding: 6px 14px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .badge-active {
            background: #10b981;
            color: white;
        }

        .badge-inactive {
            background: #6b7280;
            color: white;
        }

        .badge-admin {
            background: #f59e0b;
            color: white;
        }

        .badge-verified {
            background: #3b82f6;
            color: white;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 30px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            transition: 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            background: var(--primary-soft);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .stat-content {
            flex: 1;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-main);
            line-height: 1.2;
        }

        .stat-label {
            font-size: 0.95rem;
            color: var(--text-sub);
        }

        .profile-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .action-btn {
            padding: 15px;
            border-radius: 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-main);
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
        }

        .action-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .action-btn.danger:hover {
            background: #ef4444;
            border-color: #ef4444;
            color: white;
        }

        .uploads-section {
            background: var(--surface);
            border-radius: 24px;
            padding: 25px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }

        .uploads-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .uploads-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-stats {
            display: flex;
            gap: 20px;
            background: var(--bg);
            padding: 10px 20px;
            border-radius: 50px;
        }

        .upload-stat {
            text-align: center;
        }

        .upload-stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }

        .upload-stat-label {
            font-size: 0.85rem;
            color: var(--text-sub);
        }

        .no-uploads {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-sub);
            background: var(--bg);
            border-radius: 16px;
        }

        .no-uploads i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .no-uploads p {
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 24px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-sub);
            cursor: pointer;
            transition: 0.2s;
        }

        .modal-close:hover {
            color: var(--text-main);
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 20px;
        }

        /* Admin Dashboard Styles - Mobile Responsive */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-soft) 100%);
            border-radius: 24px;
            padding: 30px;
            margin-bottom: 30px;
            color: white;
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--surface);
            padding: 10px;
            border-radius: 50px;
            border: 1px solid var(--border);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .admin-tabs::-webkit-scrollbar {
            display: none;
        }

        .admin-tab {
            flex: 0 0 auto;
            padding: 10px 20px;
            text-align: center;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            white-space: nowrap;
        }

        .admin-tab.active {
            background: var(--primary);
            color: white;
        }

        .admin-section {
            background: var(--surface);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .admin-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .admin-section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            display: block;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .admin-table th {
            text-align: left;
            padding: 12px 10px;
            color: var(--text-sub);
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .admin-table td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .admin-status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .admin-action-btn {
            padding: 6px 10px;
            border-radius: 8px;
            border: none;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            margin: 2px;
            white-space: nowrap;
        }

        .admin-action-btn.approve {
            background: #10b981;
            color: white;
        }

        .admin-action-btn.reject {
            background: #ef4444;
            color: white;
        }

        .admin-action-btn.delete {
            background: #6b7280;
            color: white;
        }

        .admin-action-btn.edit {
            background: var(--primary);
            color: white;
        }

        .admin-action-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .notification-sender {
            background: var(--bg);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        /* Button Group */
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .admin-section {
                padding: 15px;
            }
            
            .admin-table td, .admin-table th {
                padding: 10px 8px;
                font-size: 0.85rem;
            }
            
            .admin-action-btn {
                padding: 5px 8px;
                font-size: 0.75rem;
            }
            
            .admin-tabs {
                padding: 8px;
            }
            
            .admin-tab {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
        }

        /* Markdown Preview */
        .markdown-preview {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
            font-size: 0.95rem;
        }

        .markdown-preview h1 { font-size: 1.8rem; }
        .markdown-preview h2 { font-size: 1.5rem; }
        .markdown-preview h3 { font-size: 1.3rem; }
        .markdown-preview p { margin-bottom: 10px; }
        .markdown-preview a { color: var(--primary); }
        .markdown-preview code { 
            background: var(--surface);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: monospace;
        }
        .markdown-preview pre {
            background: var(--surface);
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
        }

        /* Link Button */
        .link-btn {
            background: var(--primary-soft);
            color: var(--primary);
            padding: 8px 15px;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            margin: 5px 0;
        }

        .link-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--surface);
            color: var(--text-main);
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            opacity: 0;
            transition: all 0.3s;
            border: 1px solid var(--border);
            font-weight: 500;
            text-align: center;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: #10b981;
            color: white;
        }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <div class="header-main" id="headerMain">
            <div class="brand" onclick="navigateTo('/')">
                <img src="https://iili.io/fY4mez7.jpg" alt="Profile" class="brand-img" onerror="this.onerror=null;this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='">
                <span class="brand-text">FileHub</span>
                <span id="adminBadge" class="admin-badge">Admin</span>
            </div>
            <div class="header-actions">
                <button class="icon-btn" id="aiBtn"><img src="https://iili.io/fYWPezx.jpg" alt="AI" class="ai-icon-img" id="headerAiIcon" onerror="this.onerror=null;this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='"></button>
                
                <button class="icon-btn" id="notifBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                    <span class="notif-badge" id="notifBadge">0</span>
                </button>

                <button class="icon-btn" id="themeToggle">
                    <svg class="theme-icon-svg" id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <button class="icon-btn" id="searchTrigger"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></button>
            </div>
        </div>
        <div class="search-overlay" id="searchOverlay">
            <div class="search-box-wrapper">
                <button class="search-back-btn" id="searchBack"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></button>
                <input type="text" id="searchInput" class="search-input" placeholder="Search...">
                <button class="search-clear-btn" id="searchClear"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
        </div>
    </div>
</header>

<div class="container" id="app"></div>

<!-- Toast Notification -->
<div id="toast" class="toast"></div>

<!-- Modals -->
<div class="modal-overlay" id="authModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal('authModal')"><i class="fas fa-times"></i></button>
        <div id="authModalContent"></div>
    </div>
</div>

<div class="modal-overlay" id="editProfileModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal('editProfileModal')"><i class="fas fa-times"></i></button>
        <div id="editProfileModalContent"></div>
    </div>
</div>

<div class="modal-overlay" id="changePasswordModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal('changePasswordModal')"><i class="fas fa-times"></i></button>
        <div id="changePasswordModalContent"></div>
    </div>
</div>

<div class="modal-overlay" id="editFileModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal('editFileModal')"><i class="fas fa-times"></i></button>
        <div id="editFileModalContent"></div>
    </div>
</div>

<div class="modal-overlay" id="sendNotificationModal">
    <div class="modal-content" style="max-width: 600px;">
        <button class="modal-close" onclick="closeModal('sendNotificationModal')"><i class="fas fa-times"></i></button>
        <div id="sendNotificationModalContent"></div>
    </div>
</div>

<!-- Notification Sheet -->
<div class="bottom-sheet-overlay" id="sheetOverlay"></div>
<div class="bottom-sheet" id="notifSheet">
    <div class="sheet-header">
        <button class="sheet-btn sheet-left-btn" id="notifLeftBtn"></button>
        <span class="sheet-title">Notifications</span>
        <button class="sheet-btn" id="closeSheet">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
    </div>
    <div class="sheet-body">
        <div id="notifListView" class="view-container">
            <ul class="notif-list" id="notifList"></ul>
        </div>
        <div id="notifDetailView" class="view-container notif-detail-view">
            <div id="notifDetailContent"></div>
        </div>
    </div>
</div>

<!-- AI Assistant Sheet -->
<div class="bottom-sheet" id="aiSheet">
    <div class="sheet-header">
        <button class="sheet-btn sheet-left-btn" id="aiExpandBtn"></button>
        <span class="sheet-title">Assistant</span>
        <button class="sheet-btn" id="closeAiSheet">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
    </div>
    <div class="chat-container" id="chatList">
        <div class="chat-bubble ai">
            <img src="https://iili.io/fYWPWg9.jpg" class="ai-avatar" id="aiAvatar" onerror="this.onerror=null;this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='">
            <div class="ai-content">Hello! I'm your FileHub assistant. How can I help you today?</div>
        </div>
    </div>
    <div class="chat-footer">
        <textarea id="chatInput" class="chat-input" placeholder="Type your message..." rows="1"></textarea>
        <button id="chatSendBtn" class="chat-send-btn">
            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
        </button>
    </div>
</div>

<!-- Lightbox -->
<div class="lightbox-overlay" id="lightbox">
    <button class="lightbox-close" id="lightboxClose">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
    <img src="" class="lightbox-img" id="lightboxImg">
</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <div class="nav-col">
        <button class="nav-item" title="Upload" onclick="handleProtectedNavigation('/upload')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
        </button>
    </div>
    <div class="nav-home-wrapper">
        <button class="nav-home" title="Home" onclick="navigateTo('/')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        </button>
    </div>
    <div class="nav-col">
        <button class="nav-item" title="Account" onclick="handleProtectedNavigation('/profile')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        </button>
    </div>
</nav>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyChHkWz0MLat5pWVu2P8h85O2zxr845hdk",
        authDomain: "file-hub-70ed5.firebaseapp.com",
        databaseURL: "https://file-hub-70ed5-default-rtdb.firebaseio.com",
        projectId: "file-hub-70ed5",
        storageBucket: "file-hub-70ed5.firebasestorage.app",
        messagingSenderId: "485294935637",
        appId: "1:485294935637:web:18727eb70d4ea84c814edc"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Refs
    const usersRef = database.ref('users');
    const filesRef = database.ref('files');
    const bannersRef = database.ref('banners');
    const notificationsRef = database.ref('notifications');
    const settingsRef = database.ref('settings');
    const chatsRef = database.ref('chats');
    const adminsRef = database.ref('admins');

    // Constants
    const HEAD_AI_LIGHT = "https://iili.io/fYWPezx.jpg";
    const HEAD_AI_DARK = "https://iili.io/fYWPEs2.jpg";
    const CHAT_AI_LIGHT = "https://iili.io/fYWPWg9.jpg";
    const CHAT_AI_DARK = "https://iili.io/fYWPSqB.jpg";

    const SVG_EXPAND = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>';
    const SVG_COLLAPSE = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 14 10 14 10 20"></polyline><polyline points="20 10 14 10 14 4"></polyline><line x1="14" y1="10" x2="21" y2="3"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>';
    const SVG_BACK = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>';
    const SVG_CHECK = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
    const SVG_LINK = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>';

    // DOM Elements
    const app = document.getElementById('app');
    const searchTrigger = document.getElementById('searchTrigger');
    const searchOverlay = document.getElementById('searchOverlay');
    const searchBack = document.getElementById('searchBack');
    const searchInput = document.getElementById('searchInput');
    const searchClear = document.getElementById('searchClear');
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const adminBadge = document.getElementById('adminBadge');
    
    const notifBtn = document.getElementById('notifBtn');
    const notifBadge = document.getElementById('notifBadge');
    const sheetOverlay = document.getElementById('sheetOverlay');
    const notifSheet = document.getElementById('notifSheet');
    const closeSheet = document.getElementById('closeSheet');
    const notifLeftBtn = document.getElementById('notifLeftBtn');
    const notifList = document.getElementById('notifList');
    const notifListView = document.getElementById('notifListView');
    const notifDetailView = document.getElementById('notifDetailView');
    const notifDetailContent = document.getElementById('notifDetailContent');

    const aiBtn = document.getElementById('aiBtn');
    const aiSheet = document.getElementById('aiSheet');
    const closeAiSheet = document.getElementById('closeAiSheet');
    const aiExpandBtn = document.getElementById('aiExpandBtn'); 
    const chatList = document.getElementById('chatList');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightboxImg');
    const lightboxClose = document.getElementById('lightboxClose');

    const authModal = document.getElementById('authModal');
    const editProfileModal = document.getElementById('editProfileModal');
    const changePasswordModal = document.getElementById('changePasswordModal');
    const editFileModal = document.getElementById('editFileModal');
    const sendNotificationModal = document.getElementById('sendNotificationModal');

    // State
    let currentUser = null;
    let currentUserData = null;
    let isNotifExpanded = false;
    let isAiExpanded = false;
    let isNotifInDetail = false;
    let allNotifications = [];
    let allFiles = [];
    let allBanners = [];
    let appSettings = {};
    let bannerInterval, detailInterval;
    let notifListener = null;
    let chatHistory = [];
    let isAdmin = false;

    // AI Response Templates
    const aiResponses = [
        "I can help you find files, check your uploads, or answer questions about FileHub.",
        "You can upload files from the upload page. Make sure to provide accurate information.",
        "Your files will be reviewed by admin before they become public.",
        "The AI assistant is here to help you with any questions about FileHub.",
        "Check your profile to see your uploads and statistics.",
        "Need help with something specific? Just ask!",
        "You can search for files using the search bar at the top.",
        "Notifications about your files and updates will appear here.",
        "To download a file, click on it and follow the instructions. Some files may require watching ads first.",
        "Your profile shows your ID, join date, and upload statistics.",
        "You can change your profile picture and update your information.",
        "If you have any issues, please contact support or ask the admin."
    ];

    // Helper Functions
    function formatCount(n) {
        if (n >= 1000000) return (n / 1000000).toFixed(1).replace(/\.0$/, '') + 'm';
        if (n >= 1000) return (n / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
        return n;
    }

    function truncateExt(ext) {
        if (!ext) return 'file';
        if (ext.length > 5) return ext.substring(0, 5) + '..';
        return ext;
    }

    function timeAgoShort(timestamp) {
        if (!timestamp) return 'recent';
        const seconds = Math.floor((Date.now() - timestamp) / 1000);
        if (seconds < 60) return 'just now';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return minutes + 'm ago';
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return hours + 'h ago';
        const days = Math.floor(hours / 24);
        if (days < 30) return days + 'd ago';
        const months = Math.floor(days / 30);
        return months + 'mo ago';
    }

    const getHomeSkeleton = () => {
        let html = '<div class="skeleton" style="width:100%; aspect-ratio:16/9; margin-bottom:20px;"></div>';
        html += '<div class="skeleton" style="width:50%; height:25px; margin-bottom:20px;"></div>';
        html += '<div class="file-grid">';
        for(let i=0; i<4; i++) {
            html += `
            <div style="background:var(--surface); border-radius:12px; padding:10px;">
                <div class="skeleton sk-img"></div>
                <div class="skeleton sk-title"></div>
                <div class="skeleton sk-text"></div>
            </div>`;
        }
        html += '</div>';
        return html;
    };

    const getDetailSkeleton = () => {
        return `
            <div class="skeleton" style="width:100%; aspect-ratio:16/9; margin-bottom:20px;"></div>
            <div class="skeleton" style="width:80%; height:30px; margin-bottom:15px;"></div>
            <div class="sk-row" style="justify-content:space-between">
                <div class="skeleton" style="width:80px; height:24px;"></div>
                <div class="skeleton" style="width:80px; height:24px;"></div>
                <div class="skeleton" style="width:80px; height:24px;"></div>
            </div>
            <div class="skeleton" style="width:100%; height:100px; margin-top:20px;"></div>
        `;
    };

    const getNotifSkeleton = () => {
        let html = '';
        for(let i=0; i<5; i++) {
            html += `
            <div style="padding:15px 20px; border-bottom:1px solid var(--bg)">
                <div class="skeleton" style="width:100%; height:16px; margin-bottom:8px;"></div>
                <div class="skeleton" style="width:40%; height:12px;"></div>
            </div>`;
        }
        return html;
    };

    // Theme Functions
    function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);
        updateThemeColor(savedTheme);
        updateDynamicImages(savedTheme);
    }

    function updateThemeIcon(mode) {
        if (mode === 'dark') {
            themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
        } else {
            themeIcon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
        }
    }

    function updateThemeColor(mode) {
        const color = mode === 'dark' ? '#1e293b' : '#ffffff';
        let meta = document.querySelector('meta[name="theme-color"]');
        if (meta) meta.setAttribute('content', color);
    }

    function getAiAvatarUrl(mode) {
        return mode === 'dark' ? CHAT_AI_DARK : CHAT_AI_LIGHT;
    }

    function updateDynamicImages(mode) {
        const headerIcon = document.getElementById('headerAiIcon');
        if (headerIcon) {
            headerIcon.src = mode === 'dark' ? HEAD_AI_DARK : HEAD_AI_LIGHT;
        }
        const chatAvatar = document.getElementById('aiAvatar');
        if (chatAvatar) {
            chatAvatar.src = mode === 'dark' ? CHAT_AI_DARK : CHAT_AI_LIGHT;
        }
        const spinner = document.querySelector('.ai-loading-img');
        if (spinner) {
            spinner.src = getAiAvatarUrl(mode);
        }
    }

    themeToggle.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', next);
        
        updateThemeIcon(next);
        updateThemeColor(next);
        updateDynamicImages(next);

        themeToggle.classList.add('theme-active');
        setTimeout(() => themeToggle.classList.remove('theme-active'), 500);

        localStorage.setItem('theme', next);
        
        if (currentUser) {
            usersRef.child(currentUser.uid).child('theme').set(next).catch(console.warn);
        }
    });

    // Auth Functions
    auth.onAuthStateChanged(async (user) => {
        if (user && !user.isAnonymous) {
            currentUser = user;
            
            // Get user data
            const userSnap = await usersRef.child(user.uid).once('value');
            currentUserData = userSnap.val() || {};
            
            // Check if admin
            const adminSnap = await adminsRef.child(user.uid).once('value');
            isAdmin = adminSnap.exists();
            
            // Show admin badge only for admins
            if (isAdmin) {
                adminBadge.style.display = 'inline-block';
            } else {
                adminBadge.style.display = 'none';
            }
            
            // Load user's theme preference
            if (currentUserData.theme) {
                document.documentElement.setAttribute('data-theme', currentUserData.theme);
                updateThemeIcon(currentUserData.theme);
                updateThemeColor(currentUserData.theme);
                updateDynamicImages(currentUserData.theme);
                localStorage.setItem('theme', currentUserData.theme);
            }
            
            // Load notifications
            loadNotifications();
            
            // Load chat history
            loadChatHistory();
            
            // Update UI
            router();
        } else {
            currentUser = null;
            currentUserData = null;
            isAdmin = false;
            adminBadge.style.display = 'none';
            allNotifications = [];
            updateBadge();
            
            // Update UI
            router();
        }
    });

    // Protected Navigation
    window.handleProtectedNavigation = (path) => {
        if (currentUser) {
            navigateTo(path);
        } else {
            showAuthModal();
        }
    };

    // Modal Functions
    window.openModal = (modalId) => {
        document.getElementById(modalId).classList.add('active');
    };

    window.closeModal = (modalId) => {
        document.getElementById(modalId).classList.remove('active');
    };

    function showAuthModal() {
        document.getElementById('authModalContent').innerHTML = `
            <div class="auth-form p-0">
                <div class="auth-header">
                    <img src="https://iili.io/fY4mez7.jpg" class="auth-logo" onerror="this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='">
                    <h1 class="auth-title">Welcome to FileHub</h1>
                    <p class="auth-subtitle">Secure file storage & sharing platform</p>
                </div>
                
                <div class="auth-tabs" id="authTabs">
                    <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
                    <div class="auth-tab" onclick="switchAuthTab('register')">Register</div>
                </div>
                
                <div id="authAlert" class="alert hidden"></div>
                
                <form id="authForm">
                    <div id="registerFields" class="hidden">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" id="regFullName" class="form-control" placeholder="John Doe">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <input type="text" id="regUsername" class="form-control" placeholder="johndoe">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="authEmail" class="form-control" placeholder="your@email.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="authPassword" class="form-control" placeholder="" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="authBtn">
                        <i class="fas fa-sign-in-alt mr-2"></i> Login
                    </button>
                </form>
            </div>
        `;
        
        document.getElementById('authForm').addEventListener('submit', handleAuth);
        openModal('authModal');
    }

    // Switch between login and register tabs
    window.switchAuthTab = (tab) => {
        const tabs = document.querySelectorAll('.auth-tab');
        const registerFields = document.getElementById('registerFields');
        const authBtn = document.getElementById('authBtn');
        
        tabs.forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        
        if (tab === 'register') {
            registerFields.classList.remove('hidden');
            authBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i> Register';
        } else {
            registerFields.classList.add('hidden');
            authBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i> Login';
        }
    };

    // Handle authentication
    async function handleAuth(e) {
        e.preventDefault();
        
        const isLogin = document.getElementById('registerFields').classList.contains('hidden');
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;
        const authBtn = document.getElementById('authBtn');
        
        authBtn.disabled = true;
        authBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
        
        try {
            if (isLogin) {
                // Login
                await auth.signInWithEmailAndPassword(email, password);
                showAuthAlert('Login successful!', 'success');
                setTimeout(() => {
                    closeModal('authModal');
                    navigateTo('/');
                }, 1500);
            } else {
                // Register
                const fullName = document.getElementById('regFullName').value;
                const username = document.getElementById('regUsername').value;
                
                if (!fullName || !username) {
                    throw new Error('Please fill in all fields');
                }
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Save user data to database
                await usersRef.child(userCredential.user.uid).set({
                    email: email,
                    fullname: fullName,
                    username: username,
                    isAccountActive: true,
                    balance: 0,
                    adsWatched: 0,
                    createdAt: Date.now(),
                    theme: 'light'
                });
                
                showAuthAlert('Registration successful!', 'success');
                setTimeout(() => {
                    closeModal('authModal');
                    navigateTo('/');
                }, 1500);
            }
        } catch (error) {
            showAuthAlert(error.message, 'error');
            authBtn.disabled = false;
            authBtn.innerHTML = isLogin ? 
                '<i class="fas fa-sign-in-alt mr-2"></i> Login' : 
                '<i class="fas fa-user-plus mr-2"></i> Register';
        }
    }

    function showAuthAlert(message, type) {
        const alert = document.getElementById('authAlert');
        alert.textContent = message;
        alert.className = `alert alert-${type}`;
        alert.classList.remove('hidden');
    }

    // Load Data
    async function loadData() {
        try {
            // Load all files
            const filesSnap = await filesRef.once('value');
            allFiles = filesSnap.val() ? Object.entries(filesSnap.val())
                .map(([id, data]) => ({ id, ...data })) : [];
            
            // Load banners
            const bannersSnap = await bannersRef.once('value');
            allBanners = bannersSnap.val() ? Object.entries(bannersSnap.val())
                .map(([id, data]) => ({ id, ...data })) : [];
            
            // Load settings
            const settingsSnap = await settingsRef.once('value');
            appSettings = settingsSnap.val() || {};
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }

    // Notification Functions
    function loadNotifications() {
        if (!currentUser) return;
        
        if (notifListener) notifListener.off();
        
        notifListener = notificationsRef.orderByChild('created_at').limitToLast(50);
        notifListener.on('value', (snapshot) => {
            const notifications = snapshot.val() ? Object.entries(snapshot.val())
                .map(([id, data]) => ({ id, ...data }))
                .filter(n => !n.target_uid || n.target_uid === 'all' || n.target_uid === currentUser.uid)
                .sort((a, b) => b.created_at - a.created_at) : [];
            
            allNotifications = notifications;
            updateBadge();
            
            if (notifSheet.classList.contains('active') && notifListView.style.display !== 'none') {
                renderNotifications();
            }
        });
    }

    function updateBadge() {
        const unreadCount = allNotifications.filter(n => !n.is_read).length;
        notifBadge.innerText = unreadCount > 99 ? '99+' : unreadCount;
        if (unreadCount > 0) notifBadge.classList.add('active');
        else notifBadge.classList.remove('active');
    }

    function renderNotifications() {
        notifListView.style.display = 'block';
        notifDetailView.style.display = 'none';
        isNotifInDetail = false; 
        updateNotifLeftIcon();
        
        if (allNotifications.length === 0) {
            notifList.innerHTML = '<li style="padding:40px;text-align:center;color:var(--text-sub)">No notifications yet.</li>';
            return;
        }
        
        notifList.innerHTML = allNotifications.map(n => {
            const isUnread = !n.is_read;
            return `
            <li class="notif-item ${isUnread ? 'unread' : ''}" onclick="openNotifDetail('${n.id}')">
                <div class="notif-title-list">${n.title || 'Notification'}</div>
                <div class="notif-time">${timeAgoShort(n.created_at)}</div>
            </li>`;
        }).join('');
    }

    window.openNotifDetail = async (nid) => {
        const notification = allNotifications.find(n => n.id === nid);
        if (!notification) return;

        notifListView.style.display = 'none';
        notifDetailView.style.display = 'block';
        
        isNotifInDetail = true;
        updateNotifLeftIcon();

        const descHtml = DOMPurify.sanitize(marked.parse(notification.decs || notification.description || ''));
        notifDetailContent.innerHTML = `
            <div class="notif-detail-title">${notification.title || 'Notification'}</div>
            <div class="notif-detail-time">${timeAgoShort(notification.created_at)}</div>
            <div class="notif-detail-content markdown-body">${descHtml}</div>
        `;

        if (!notification.is_read && currentUser) {
            await notificationsRef.child(nid).update({ is_read: true }).catch(console.warn);
        }
    };

    window.closeNotifDetail = () => {
        notifDetailView.style.display = 'none';
        notifListView.style.display = 'block';
        
        isNotifInDetail = false;
        updateNotifLeftIcon();
    };

    function updateNotifLeftIcon() {
        if (isNotifInDetail) {
            notifLeftBtn.innerHTML = SVG_BACK;
            notifLeftBtn.onclick = closeNotifDetail;
        } else {
            if (isNotifExpanded) {
                notifLeftBtn.innerHTML = SVG_COLLAPSE;
            } else {
                notifLeftBtn.innerHTML = SVG_EXPAND;
            }
            notifLeftBtn.onclick = toggleNotifExpand;
        }
    }

    function toggleNotifExpand() {
        isNotifExpanded = !isNotifExpanded;
        if (isNotifExpanded) {
            notifSheet.classList.add('expanded');
        } else {
            notifSheet.classList.remove('expanded');
        }
        updateNotifLeftIcon();
    }

    notifBtn.addEventListener('click', () => {
        if (!currentUser) {
            showAuthModal();
            return;
        }
        renderNotifications();
        sheetOverlay.classList.add('active');
        notifSheet.classList.add('active');
    });

    // Sheet Functions
    function closeSheetCommon() {
        sheetOverlay.classList.remove('active');
        notifSheet.classList.remove('active');
        aiSheet.classList.remove('active');
        setTimeout(() => {
            isNotifExpanded = false;
            isAiExpanded = false;
            notifSheet.classList.remove('expanded');
            aiSheet.classList.remove('expanded');
            closeNotifDetail();
        }, 300);
    }
    
    closeSheet.addEventListener('click', closeSheetCommon);
    closeAiSheet.addEventListener('click', closeSheetCommon);
    sheetOverlay.addEventListener('click', closeSheetCommon);

    // AI Sheet Functions
    function updateAiLeftIcon() {
        if (isAiExpanded) {
            aiExpandBtn.innerHTML = SVG_COLLAPSE;
        } else {
            aiExpandBtn.innerHTML = SVG_EXPAND;
        }
    }

    function toggleAiExpand() {
        isAiExpanded = !isAiExpanded;
        if (isAiExpanded) {
            aiSheet.classList.add('expanded');
        } else {
            aiSheet.classList.remove('expanded');
        }
        updateAiLeftIcon();
    }
    
    aiExpandBtn.onclick = toggleAiExpand;

    aiBtn.addEventListener('click', () => {
        if (!currentUser) {
            showAuthModal();
            return;
        }
        sheetOverlay.classList.add('active');
        aiSheet.classList.add('active');
        updateAiLeftIcon();
    });

    async function loadChatHistory() {
        if (!currentUser) return;
        
        try {
            const snapshot = await chatsRef.orderByChild('timestamp').limitToLast(50).once('value');
            const chats = snapshot.val() ? Object.entries(snapshot.val())
                .map(([id, data]) => ({ id, ...data }))
                .filter(chat => chat.userId === currentUser.uid)
                .sort((a, b) => a.timestamp - b.timestamp) : [];
            
            chatHistory = chats;
            
            // Clear existing messages except the first AI greeting
            while (chatList.children.length > 1) {
                chatList.removeChild(chatList.lastChild);
            }
            
            chats.forEach(chat => {
                appendMessage(chat.role, chat.content, false);
            });
            
            scrollToBottom();
        } catch(e) {
            console.error('Error loading chat history:', e);
        }
    }

    function appendMessage(role, text, saveToHistory = true) {
        const div = document.createElement('div');
        div.className = `chat-bubble ${role}`;
        
        if (role === 'ai') {
            const parsed = DOMPurify.sanitize(marked.parse(text));
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const avatarUrl = getAiAvatarUrl(currentTheme);
            div.innerHTML = `
                <img src="${avatarUrl}" class="ai-avatar">
                <div class="ai-content">${parsed}</div>
            `;
        } else {
            div.innerText = text; 
        }
        
        chatList.appendChild(div);
        scrollToBottom();
        
        if (role === 'ai' && saveToHistory) {
            hljs.highlightAll();
        }
    }

    function showTypingIndicator() {
        const div = document.createElement('div');
        div.className = 'typing-container';
        div.id = 'typingIndicator';
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const avatarUrl = getAiAvatarUrl(currentTheme);
        
        div.innerHTML = `
            <img src="${avatarUrl}" class="ai-loading-img">
            <div class="typing-dots">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
        `;
        chatList.appendChild(div);
        scrollToBottom();
    }

    function removeTypingIndicator() {
        const el = document.getElementById('typingIndicator');
        if(el) el.remove();
    }

    function scrollToBottom() {
        chatList.scrollTop = chatList.scrollHeight;
    }

    chatSendBtn.addEventListener('click', sendMessage);
    
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    async function sendMessage() {
        const text = chatInput.value.trim();
        if(!text) return;
        
        chatInput.value = '';
        chatInput.style.height = 'auto';
        
        appendMessage('user', text);
        showTypingIndicator();
        
        try {
            // Save user message
            if (currentUser) {
                await chatsRef.push({
                    userId: currentUser.uid,
                    role: 'user',
                    content: text,
                    timestamp: Date.now()
                });
            }
            
            // Generate AI response
            setTimeout(async () => {
                removeTypingIndicator();
                
                let response = "";
                
                if (text.toLowerCase().includes('hello') || text.toLowerCase().includes('hi') || text.toLowerCase().includes('hey')) {
                    response = "Hello! How can I assist you with FileHub today?";
                } else if (text.toLowerCase().includes('upload')) {
                    response = "To upload files, click the upload button at the bottom. Fill in the title, description, and URLs. Your file will be reviewed by admin before going public.";
                } else if (text.toLowerCase().includes('download')) {
                    response = "Click on any file card to view details. If ads are required, watch them to unlock the download link. Free files can be downloaded directly.";
                } else if (text.toLowerCase().includes('profile')) {
                    response = "Your profile shows your statistics, uploaded files, and account info. You can edit your profile and change settings there.";
                } else if (text.toLowerCase().includes('notification')) {
                    response = "Notifications keep you updated about your files, approvals, and system announcements. Click the bell icon to view them.";
                } else if (text.toLowerCase().includes('admin')) {
                    response = "Admin users have special privileges to manage files, banners, and send notifications to all users.";
                } else if (text.toLowerCase().includes('balance') || text.toLowerCase().includes('earning')) {
                    response = "Your balance is shown in your profile. You earn from file downloads and other activities on the platform.";
                } else if (text.toLowerCase().includes('file') || text.toLowerCase().includes('resource')) {
                    response = "Browse files on the home page. Use the search bar to find specific resources. Each file has details and download options.";
                } else if (text.toLowerCase().includes('help')) {
                    response = "I can help with: uploads, downloads, profile management, notifications, files, and more. Just ask a specific question!";
                } else {
                    response = aiResponses[Math.floor(Math.random() * aiResponses.length)];
                }
                
                appendMessage('ai', response);
                
                // Save AI response
                if (currentUser) {
                    await chatsRef.push({
                        userId: currentUser.uid,
                        role: 'ai',
                        content: response,
                        timestamp: Date.now()
                    });
                }
            }, 1500);
            
        } catch (e) {
            removeTypingIndicator();
            appendMessage('ai', '**Error:** Failed to get response. Please try again.');
            console.error(e);
        }
    }

    // Search Functions
    searchTrigger.addEventListener('click', () => { 
        searchOverlay.classList.add('active'); 
        searchInput.focus(); 
    });
    
    searchBack.addEventListener('click', () => { 
        searchOverlay.classList.remove('active'); 
        searchInput.value = ''; 
        if(searchInput.value.length === 0) searchClear.classList.remove('visible');
        filterFiles('');
    });
    
    searchInput.addEventListener('input', (e) => {
        const term = e.target.value;
        if(term.length > 0) searchClear.classList.add('visible'); 
        else searchClear.classList.remove('visible');
        filterFiles(term);
    });

    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            searchInput.blur();
            searchOverlay.classList.remove('active'); 
        }
    });

    searchClear.addEventListener('click', () => {
        searchInput.value = ''; 
        searchInput.focus(); 
        searchClear.classList.remove('visible');
        filterFiles('');
    });

    function filterFiles(term) {
        term = term.toLowerCase();
        const cards = document.querySelectorAll('.file-card');
        if(cards.length === 0) return;
        
        cards.forEach(card => {
            const title = card.querySelector('.card-title')?.innerText.toLowerCase() || '';
            card.style.display = title.includes(term) ? 'flex' : 'none';
        });
    }

    // Lightbox Functions
    window.openLightbox = (src) => {
        if (!src) return;
        lightboxImg.src = src;
        lightbox.style.display = 'flex';
        requestAnimationFrame(() => {
            lightbox.classList.add('active');
        });
    };

    window.closeLightbox = () => {
        lightbox.classList.remove('active');
        setTimeout(() => {
            lightbox.style.display = 'none';
            lightboxImg.src = '';
        }, 300);
    };

    lightboxClose.addEventListener('click', window.closeLightbox);
    lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) window.closeLightbox();
    });

    // Navigation
    window.navigateTo = (url) => {
        window.history.pushState({}, '', url);
        router();
    };

    function renderError(title, msg) {
        app.innerHTML = `
            <div class="error-container">
                <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <div class="error-title">${title}</div>
                <div style="color:var(--text-sub)">${msg}</div>
                <button class="error-btn" onclick="navigateTo('/')">Go Home</button>
            </div>
        `;
    }

    // Router
    async function router() {
        const path = window.location.pathname;
        clearInterval(bannerInterval);
        clearInterval(detailInterval);
        
        await loadData();
        
        if (path === '/' || path === '/index.html') {
            renderHome();
        }
        else if (path.startsWith('/file/')) {
            const id = path.split('/file/')[1];
            if(id) renderDetail('file', id); 
            else renderError('Page Not Found', 'The requested page could not be found.');
        }
        else if (path.startsWith('/banner/')) {
             const id = path.split('/banner/')[1];
             if(id) renderDetail('banner', id); 
             else renderError('Page Not Found', 'The requested page could not be found.');
        }
        else if (path === '/upload') {
            if (currentUser) {
                renderUpload();
            } else {
                showAuthModal();
            }
        }
        else if (path === '/profile') {
            if (currentUser) {
                renderProfile();
            } else {
                showAuthModal();
            }
        }
        else if (path === '/admin' && isAdmin) {
            renderAdminDashboard();
        }
        else {
             renderError('Page Not Found', 'The requested page could not be found.');
        }
    }

    // ====================   ====================

    // Toast 
    function showToast(message, type = 'normal') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast show';
        if (type === 'success') {
            toast.classList.add('success');
        }
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 2000);
    }

    //   
    function generateShortCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < 6; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    //     
    function getFileShortLink(fileId, fileType, title) {
        const key = `short_${fileType}_${fileId}`;
        let shortCode = localStorage.getItem(key);
        
        if (!shortCode) {
            shortCode = generateShortCode();
            localStorage.setItem(key, shortCode);
            
            const linkData = {
                fileId,
                fileType,
                title,
                shortCode,
                createdAt: Date.now(),
                clicks: 0
            };
            localStorage.setItem(`link_${shortCode}`, JSON.stringify(linkData));
        }
        
        return shortCode;
    }

    //    
    window.shareFile = function(fileId, fileType, title, button) {
        //   
        const shortCode = getFileShortLink(fileId, fileType, title);
        
        //   
        const shortUrl = `${window.location.origin}${window.location.pathname}#/file/${shortCode}`;
        
        //  
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(shortUrl).then(() => {
                //   
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.style.background = '#10b981';
                button.style.color = 'white';
                
                showToast('   !', 'success');
                
                setTimeout(() => {
                    button.innerHTML = '<i class="fas fa-share-alt"></i>';
                    button.style.background = '';
                    button.style.color = '';
                }, 2000);
            }).catch(() => {
                fallbackCopy(shortUrl, button);
            });
        } else {
            fallbackCopy(shortUrl, button);
        }
    };

    // allback 
    function fallbackCopy(text, button) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
            document.execCommand('copy');
            button.innerHTML = '<i class="fas fa-check"></i>';
            button.style.background = '#10b981';
            button.style.color = 'white';
            showToast('   !', 'success');
            
            setTimeout(() => {
                button.innerHTML = '<i class="fas fa-share-alt"></i>';
                button.style.background = '';
                button.style.color = '';
            }, 2000);
        } catch (err) {
            showToast('   ', 'normal');
        }
        
        document.body.removeChild(textarea);
    }

    //    
    function checkForShortLink() {
        const hash = window.location.hash;
        if (hash && hash.startsWith('#/file/')) {
            const shortCode = hash.replace('#/file/', '');
            
            const linkData = localStorage.getItem(`link_${shortCode}`);
            if (linkData) {
                const data = JSON.parse(linkData);
                
                //   
                data.clicks = (data.clicks || 0) + 1;
                data.lastClicked = Date.now();
                localStorage.setItem(`link_${shortCode}`, JSON.stringify(data));
                
                // 
                showToast(`  : ${data.title}`, 'normal');
                
                setTimeout(() => {
                    window.location.href = `/file/${data.fileId}`;
                }, 1500);
            } else {
                showToast('    ', 'normal');
            }
        }
    }

    // Home Page (  )
    function renderHome() {
        document.title = "Dashboard - FileHub";
        
        app.innerHTML = getHomeSkeleton();

        try {
            // Get approved files only for home page
            const approvedFiles = allFiles.filter(f => f.status === 'approved');
            
            // Build banner HTML
            let bannerHTML = '';
            if (allBanners.length > 0) {
                const dots = allBanners.map((_, i) => `<span class="dot-c ${i===0?'active':''}"></span>`).join('');
                bannerHTML = `
                <div class="carousel-wrap" id="homeCarousel">
                    <div class="carousel-inner" id="homeInner">
                        ${allBanners.map(b => `
                            <div class="slide" onclick="navigateTo('/banner/${b.id}')">
                                <img src="${b.thumbnail_url || ''}" onerror="this.onerror=null;this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='">
                                <div class="center-eye">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                                </div>
                                <div class="slide-overlay">
                                    <span class="banner-pill">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                        ${truncateExt(b.file_extension)}
                                    </span>
                                    <div class="slide-title" style="flex:1; text-align:center; padding:0 5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${b.title || 'Banner'}</div>
                                    <span class="banner-pill">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                        ${formatCount(b.total_downloads || 0)}
                                    </span>
                                </div>
                            </div>`).join('')}
                    </div>
                </div>
                <div class="carousel-dots" id="homeDots">${dots}</div>`;
            }

            // Build files HTML with share button
            let filesHTML = approvedFiles.length ? approvedFiles.map(f => {
                const safeTitle = (f.title || 'Untitled').replace(/'/g, "\\'");
                return `
                <div class="file-card" onclick="navigateTo('/file/${f.id}')">
                    <img src="${f.thumbnail_url || ''}" class="card-thumb" onerror="this.onerror=null;this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='">
                    <div class="card-body">
                        <div class="card-title">${f.title || 'Untitled'}</div>
                        <div class="card-footer">
                            <span class="meta-pill">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                ${truncateExt(f.file_extension)}
                            </span>
                            <span class="meta-pill">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                ${formatCount(f.total_downloads || 0)}
                            </span>
                            <button class="share-btn" onclick="event.stopPropagation(); shareFile('${f.id}', 'file', '${safeTitle}', this)">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('') : '<p style="text-align:center;color:var(--text-sub);grid-column:1/-1">No files found.</p>';

            app.innerHTML = `${bannerHTML}
                <div class="section-header">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M11 21h-1l1-7H7.5c-.58 0-.57-.32-.38-.66.19-.34.05-.08.07-.12C8.48 10.94 10.42 7.54 13 3h1l-1 7h3.5c.49 0 .56.33.47.51l-.07.15C12.96 17.55 11 21 11 21z"/></svg>
                    <h2>Latest Resources</h2>
                </div>
                <div class="file-grid">${filesHTML}</div>`;

            if(allBanners.length > 1) initCarousel('homeInner', 'homeDots', allBanners.length, true);

        } catch (e) {
            console.error('Error rendering home:', e);
            app.innerHTML = '<div style="text-align:center;padding:50px;color:var(--text-sub)">Failed to load content. Please refresh.</div>';
        }
    }

    // Detail Page (  )
    async function renderDetail(type, id) {
        app.innerHTML = getDetailSkeleton();

        try {
            const ref = type === 'file' ? filesRef : bannersRef;
            const snapshot = await ref.child(id).once('value');
            
            if (!snapshot.exists()) {
                renderError('Content Not Found', 'The file you are looking for does not exist or has been removed.');
                return;
            }

            const item = { id, ...snapshot.val() };
            document.title = `${item.title || 'File'} - FileHub`;

            // Get watched count
            let watched = 0;
            if (currentUser) {
                const statusRef = database.ref(`user_file_status/${currentUser.uid}_${item.id}`);
                const statusSnap = await statusRef.once('value');
                watched = statusSnap.val() || 0;
            } else {
                watched = parseInt(localStorage.getItem(`ad_${item.id}`) || '0');
            }

            // Build carousel
            let carouselHTML = '';
            if (item.detail_photos && item.detail_photos.length > 0) {
                const dots = item.detail_photos.map((_, i) => `<span class="dot-c ${i===0?'active':''}"></span>`).join('');
                carouselHTML = `
                <div class="carousel-wrap" id="detailWrap">
                    <div class="carousel-inner" id="detailInner">
                        ${item.detail_photos.map(u => `<div class="slide"><img src="${u}" onclick="openLightbox(this.src)" onerror="this.onerror=null;this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='"></div>`).join('')}
                    </div>
                </div>
                <div class="carousel-dots" id="detailDots">${dots}</div>`;
            } else if (item.thumbnail_url) {
                 carouselHTML = `<div class="carousel-wrap"><div class="slide"><img src="${item.thumbnail_url}" onclick="openLightbox(this.src)" onerror="this.onerror=null;this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='"></div></div>`;
            }

            const desc = DOMPurify.sanitize(marked.parse(item.description || 'No description available.'));
            const safeTitle = (item.title || 'Untitled').replace(/'/g, "\\'");

            app.innerHTML = `
                <div class="detail-wrapper">
                    ${carouselHTML}
                    <div class="detail-header-block">
                        <h1 class="detail-title">${item.title || 'Untitled'}</h1>
                        <div class="detail-meta-grid">
                            <span class="meta-pill meta-left">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                ${item.file_extension || 'file'}
                            </span>
                            <span class="meta-pill meta-center">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                ${formatCount(item.total_downloads || 0)}
                            </span>
                            <span class="meta-pill meta-right">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                ${timeAgoShort(item.created_at)}
                            </span>
                        </div>
                    </div>
                    <div class="detail-desc markdown-body">${desc}</div>
                    <div id="unlockSection" class="unlock-inline"></div>
                </div>`;
            
            hljs.highlightAll();
            if (item.detail_photos && item.detail_photos.length > 1) {
                initCarousel('detailInner', 'detailDots', item.detail_photos.length, false);
            }

            renderUnlockLogic(type, item, watched, safeTitle);

        } catch(e) {
            console.error('Error loading detail:', e);
            renderError('Connection Error', 'Failed to load content. Please check your connection.');
        }
    }

    // Unlock Logic (  )
    function renderUnlockLogic(type, item, watched, safeTitle) {
        const zone = document.getElementById('unlockSection');
        const req = item.required_ads || 0;
        
        let mainBtnHtml = '';

        if (watched >= req && req > 0) {
            mainBtnHtml = `
                <button class="unlock-btn" id="dlBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> 
                    Download Now
                </button>`;
        } else if (req > 0) {
            let btnText = `Watch Ads: ${watched}/${req}`;
            if (watched > 0) btnText = `Unlock: ${watched}/${req}`;
            
            const icon = watched > 0 ? 
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>' : 
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';

            mainBtnHtml = `
                <button class="unlock-btn" onclick="triggerAd('${item.id}', ${watched}, ${req}, '${item.monitech_ad_id || ''}', '${type}')">
                    ${icon} ${btnText}
                </button>`;
        } else {
            mainBtnHtml = `
                <button class="unlock-btn" id="dlBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> 
                    Download Now
                </button>`;
        }

        zone.innerHTML = `
            <div class="unlock-actions">
                ${mainBtnHtml}
                <button class="copy-btn" onclick="copyPageLink(this, '${window.location.href}')" title="Copy Link">
                    ${SVG_LINK}
                </button>
                <button class="share-btn" onclick="shareFile('${item.id}', '${type}', '${safeTitle}', this)" title="Share">
                    <i class="fas fa-share-alt"></i>
                </button>
            </div>
            <div id="dlStatus" style="text-align:center; margin-top:10px; font-size:0.85rem; color:var(--text-sub)"></div>`;

        const dlBtn = document.getElementById('dlBtn');
        if(dlBtn) {
            dlBtn.onclick = async function() {
                if (!item.download_url) {
                    document.getElementById('dlStatus').innerText = 'Download URL not available.';
                    return;
                }
                
                this.innerText = "Redirecting..."; 
                this.disabled = true;
                
                // Increment download count
                const ref = type === 'file' ? filesRef : bannersRef;
                await ref.child(item.id).child('total_downloads').transaction(current => (current || 0) + 1);
                
                window.location.href = item.download_url;
            };
        }
    }

    // Copy Page Link function
    window.copyPageLink = (btn, link) => {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(link).then(() => {
                showCopySuccess(btn);
            }).catch(err => {
                fallbackCopyLink(btn, link);
            });
        } else {
            fallbackCopyLink(btn, link);
        }
    };

    function fallbackCopyLink(btn, link) {
        const textarea = document.createElement('textarea');
        textarea.value = link;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        textarea.setSelectionRange(0, 99999);
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showCopySuccess(btn);
            } else {
                showCopyError(btn);
            }
        } catch (err) {
            showCopyError(btn);
        }
        
        document.body.removeChild(textarea);
    }

    function showCopySuccess(btn) {
        const originalIcon = btn.innerHTML;
        btn.innerHTML = SVG_CHECK;
        btn.style.borderColor = '#10b981';
        btn.style.color = '#10b981';
        
        const status = document.getElementById('dlStatus');
        if (status) {
            status.innerText = 'Link copied!';
            status.style.color = '#10b981';
        }
        
        setTimeout(() => {
            btn.innerHTML = originalIcon;
            btn.style.borderColor = '';
            btn.style.color = '';
            if (status) {
                status.innerText = '';
            }
        }, 2000);
    }

    function showCopyError(btn) {
        const status = document.getElementById('dlStatus');
        if (status) {
            status.innerText = 'Failed to copy. Select manually.';
            status.style.color = '#ef4444';
        }
        
        setTimeout(() => {
            if (status) {
                status.innerText = '';
            }
        }, 3000);
    }

    // triggerAd function
    window.triggerAd = async (fileId, currentWatched, reqAds, zoneId, type) => {
        const btn = document.querySelector('.unlock-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Ad...';
        btn.disabled = true;

        try {
            if (zoneId) {
                await loadMonetagScript(zoneId);
                
                if (window[`show_${zoneId}`] && typeof window[`show_${zoneId}`] === 'function') {
                    await window[`show_${zoneId}`]();
                } else {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            } else {
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            
            const newWatchedCount = currentWatched + 1;

            if (currentUser) {
                const statusRef = database.ref(`user_file_status/${currentUser.uid}_${fileId}`);
                await statusRef.set(newWatchedCount);
                
                await usersRef.child(currentUser.uid).child('adsWatched').transaction(current => (current || 0) + 1);
            } else {
                localStorage.setItem(`ad_${fileId}`, newWatchedCount);
            }

            window.location.reload();

        } catch(e) {
            btn.innerHTML = originalText;
            btn.disabled = false;
            document.getElementById('dlStatus').innerText = "Ad failed to load. Please try again.";
            console.error(e);
        }
    };

    // loadMonetagScript function
    function loadMonetagScript(zoneId) {
        return new Promise((resolve, reject) => {
            const scriptId = `monetag-script-${zoneId}`;
            if (document.getElementById(scriptId)) {
                return resolve();
            }
            
            const script = document.createElement('script');
            script.id = scriptId;
            script.src = 'https://libtl.com/sdk.js';
            script.dataset.zone = zoneId;
            script.dataset.sdk = `show_${zoneId}`;
            script.onload = resolve;
            script.onerror = () => {
                console.warn('Monetag script failed to load, using fallback');
                resolve();
            };
            document.body.appendChild(script);
            
            setTimeout(resolve, 3000);
        });
    }

    function initCarousel(innerId, dotsId, count, isHome) {
        const inner = document.getElementById(innerId);
        const dots = document.getElementById(dotsId)?.children;
        if (!inner || !dots) return;
        
        let idx = 0;
        let interval;

        function update() {
            inner.style.transform = `translateX(-${idx * 100}%)`;
            for(let d of dots) d.classList.remove('active');
            dots[idx]?.classList.add('active');
        }
        function next() { idx = (idx + 1) % count; update(); }
        function prev() { idx = (idx - 1 + count) % count; update(); }
        
        function startTimer() {
             interval = setInterval(next, 5000);
             if(isHome) bannerInterval = interval; else detailInterval = interval;
        }

        startTimer();

        let touchStartX = 0;
        let touchEndX = 0;

        inner.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            clearInterval(interval);
        }, {passive: true});

        inner.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            if (touchEndX < touchStartX - 50) next(); 
            if (touchEndX > touchStartX + 50) prev(); 
            startTimer();
        }, {passive: true});
    }

    // Upload Page
    function renderUpload() {
        document.title = "Upload - FileHub";
        
        if (!currentUser) {
            showAuthModal();
            return;
        }

        app.innerHTML = `
            <div class="upload-form">
                <h1 class="text-2xl font-bold mb-6">Upload New File</h1>
                
                <div id="upload-alert" class="alert hidden"></div>
                
                <form id="upload-form">
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" id="upload-title" class="form-control" placeholder="Enter file title" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="upload-description" class="form-control" rows="4" placeholder="Describe your file" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">File Extension</label>
                        <input type="text" id="upload-extension" class="form-control" placeholder=".zip, .rar, .pdf" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Thumbnail URL</label>
                        <input type="url" id="upload-thumbnail" class="form-control" placeholder="https://example.com/image.jpg" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Download URL</label>
                        <input type="url" id="upload-download" class="form-control" placeholder="https://example.com/file.zip" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Required Ads (0 for free)</label>
                        <input type="number" id="upload-ads" class="form-control" value="0" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Monetag Zone ID (optional)</label>
                        <input type="text" id="upload-zone" class="form-control" placeholder="e.g., 123456">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Detail Photos (optional, comma separated URLs)</label>
                        <textarea id="upload-photos" class="form-control" rows="2" placeholder="https://example.com/photo1.jpg, https://example.com/photo2.jpg"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-full" id="upload-btn">
                        <i class="fas fa-upload mr-2"></i> Upload File
                    </button>
                </form>
            </div>
        `;

        document.getElementById('upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('upload-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Uploading...';
            
            const fileData = {
                title: document.getElementById('upload-title').value,
                description: document.getElementById('upload-description').value,
                file_extension: document.getElementById('upload-extension').value,
                thumbnail_url: document.getElementById('upload-thumbnail').value,
                download_url: document.getElementById('upload-download').value,
                required_ads: parseInt(document.getElementById('upload-ads').value) || 0,
                monitech_ad_id: document.getElementById('upload-zone').value,
                detail_photos: document.getElementById('upload-photos').value.split(',').map(u => u.trim()).filter(u => u),
                status: 'pending',
                created_at: Date.now(),
                total_downloads: 0,
                uploadedBy: currentUser.uid,
                uploadedByEmail: currentUser.email
            };
            
            try {
                await filesRef.push(fileData);
                
                showAlert('upload-alert', 'File uploaded successfully! It will be visible after admin approval.', 'success');
                document.getElementById('upload-form').reset();
                
                setTimeout(() => navigateTo('/'), 2000);
            } catch (error) {
                showAlert('upload-alert', error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-upload mr-2"></i> Upload File';
            }
        });
    }

    // Profile Page
    function renderProfile() {
        document.title = "Profile - FileHub";
        
        if (!currentUser) {
            showAuthModal();
            return;
        }

        const userFiles = allFiles.filter(f => f.uploadedBy === currentUser.uid);
        const totalDownloads = userFiles.reduce((sum, f) => sum + (f.total_downloads || 0), 0);
        const approvedFiles = userFiles.filter(f => f.status === 'approved').length;
        const pendingFiles = userFiles.filter(f => f.status === 'pending').length;
        const rejectedFiles = userFiles.filter(f => f.status === 'rejected').length;

        let adsWatched = 0;
        if (currentUserData && currentUserData.adsWatched) {
            adsWatched = currentUserData.adsWatched;
        }

        const joinDate = currentUser.metadata?.creationTime ? new Date(currentUser.metadata.creationTime) : new Date();
        const formattedJoinDate = `${joinDate.getMonth()+1}/${joinDate.getDate()}/${joinDate.getFullYear()}`;

        const username = currentUserData?.username || 'username';
        const fullname = currentUserData?.fullname || currentUser.displayName || 'User';
        const email = currentUser.email || 'email@example.com';
        const avatar = currentUserData?.avatar || 'https://iili.io/fY4mez7.jpg';
        const isActive = currentUserData?.isAccountActive !== false;

        const adminLink = isAdmin ? `
            <button class="action-btn" onclick="navigateTo('/admin')">
                <i class="fas fa-cog"></i>
                Admin Dashboard
            </button>
        ` : '';

        app.innerHTML = `
            <div class="profile-container">
                <div class="profile-header">
                    <div class="profile-avatar-wrapper">
                        <img src="${avatar}" class="profile-avatar" id="profileAvatar" onclick="openLightbox(this.src)" onerror="this.src='https://iili.io/fY4mez7.jpg'">
                        <div class="profile-avatar-edit" onclick="editAvatar()">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <div class="profile-info">
                        <h1 class="profile-name">${fullname}</h1>
                        <div class="profile-username">
                            <i class="fas fa-at"></i> ${username}
                        </div>
                        <div class="profile-email">
                            <i class="fas fa-envelope"></i> ${email}
                        </div>
                        <div class="profile-badges">
                            <span class="badge ${isActive ? 'badge-active' : 'badge-inactive'}">
                                <i class="fas ${isActive ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                                ${isActive ? 'Active' : 'Inactive'}
                            </span>
                            ${isAdmin ? '<span class="badge badge-admin"><i class="fas fa-crown"></i>Admin</span>' : ''}
                            <span class="badge badge-verified">
                                <i class="fas fa-id-card"></i> ID: ${currentUser.uid.substring(0,8)}
                            </span>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-download"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">${totalDownloads}</div>
                            <div class="stat-label">Downloads</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">${userFiles.length}</div>
                            <div class="stat-label">Uploads</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">${adsWatched}</div>
                            <div class="stat-label">Ads Watched</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">${formattedJoinDate}</div>
                            <div class="stat-label">Joined</div>
                        </div>
                    </div>
                </div>

                <div class="profile-actions">
                    ${adminLink}
                    <button class="action-btn" onclick="openEditProfileModal()">
                        <i class="fas fa-user-edit"></i>
                        Edit Profile
                    </button>
                    <button class="action-btn" onclick="openChangePasswordModal()">
                        <i class="fas fa-key"></i>
                        Change Password
                    </button>
                    <button class="action-btn danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>

                <div class="uploads-section">
                    <div class="uploads-header">
                        <h2 class="uploads-title">
                            <i class="fas fa-cloud-upload-alt" style="color: var(--primary);"></i>
                            Your Uploads
                        </h2>
                        <div class="upload-stats">
                            <div class="upload-stat">
                                <div class="upload-stat-value">${approvedFiles}</div>
                                <div class="upload-stat-label">Approved</div>
                            </div>
                            <div class="upload-stat">
                                <div class="upload-stat-value">${pendingFiles}</div>
                                <div class="upload-stat-label">Pending</div>
                            </div>
                            <div class="upload-stat">
                                <div class="upload-stat-value">${rejectedFiles}</div>
                                <div class="upload-stat-label">Rejected</div>
                            </div>
                        </div>
                    </div>

                    <div class="file-grid">
                        ${userFiles.length > 0 ? userFiles.map(f => {
                            let statusClass = '';
                            let statusIcon = '';
                            
                            if (f.status === 'approved') {
                                statusClass = 'status-approved';
                                statusIcon = '<i class="fas fa-check-circle"></i>';
                            } else if (f.status === 'pending') {
                                statusClass = 'status-pending';
                                statusIcon = '<i class="fas fa-clock"></i>';
                            } else if (f.status === 'rejected') {
                                statusClass = 'status-rejected';
                                statusIcon = '<i class="fas fa-times-circle"></i>';
                            }
                            
                            return `
                                <div class="file-card" onclick="navigateTo('/file/${f.id}')">
                                    <img src="${f.thumbnail_url || ''}" class="card-thumb" onerror="this.onerror=null;this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='">
                                    <div class="card-body">
                                        <div class="card-title">${f.title || 'Untitled'}</div>
                                        <div class="card-footer">
                                            <span class="status-badge ${statusClass}">
                                                ${statusIcon} ${f.status || 'pending'}
                                            </span>
                                            <span class="meta-pill">
                                                <i class="fas fa-download"></i>
                                                ${f.total_downloads || 0}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('') : `
                            <div class="no-uploads">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>No files uploaded yet.</p>
                                <button class="btn btn-primary" onclick="navigateTo('/upload')">
                                    <i class="fas fa-upload"></i> Upload Now
                                </button>
                            </div>
                        `}
                    </div>
                </div>
            </div>
        `;
    }

    // Admin Dashboard functions (simplified)
    function renderAdminDashboard() {
        document.title = "Admin Dashboard - FileHub";
        
        if (!isAdmin) {
            navigateTo('/');
            return;
        }

        const totalFiles = allFiles.length;
        const approvedFiles = allFiles.filter(f => f.status === 'approved').length;
        const pendingFiles = allFiles.filter(f => f.status === 'pending').length;
        const rejectedFiles = allFiles.filter(f => f.status === 'rejected').length;

        app.innerHTML = `
            <div class="admin-container">
                <div class="admin-header">
                    <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 10px;">Admin Dashboard</h1>
                    <p style="opacity: 0.9;">Manage files, banners, users and notifications</p>
                    <div class="stats-grid" style="margin-top: 20px;">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-file"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">${totalFiles}</div>
                                <div class="stat-label">Total Files</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-check-circle" style="color: #10b981;"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">${approvedFiles}</div>
                                <div class="stat-label">Approved</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-clock" style="color: #f59e0b;"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">${pendingFiles}</div>
                                <div class="stat-label">Pending</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-times-circle" style="color: #ef4444;"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">${rejectedFiles}</div>
                                <div class="stat-label">Rejected</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="admin-tabs">
                    <div class="admin-tab active" onclick="switchAdminTab('files')">Files</div>
                    <div class="admin-tab" onclick="switchAdminTab('banners')">Banners</div>
                    <div class="admin-tab" onclick="switchAdminTab('users')">Users</div>
                    <div class="admin-tab" onclick="switchAdminTab('notifications')">Notifications</div>
                </div>

                <div id="adminContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        `;

        loadAdminFilesTab();
    }

    window.switchAdminTab = (tab) => {
        const tabs = document.querySelectorAll('.admin-tab');
        tabs.forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');

        switch(tab) {
            case 'files':
                loadAdminFilesTab();
                break;
            case 'banners':
                loadAdminBannersTab();
                break;
            case 'users':
                loadAdminUsersTab();
                break;
            case 'notifications':
                loadAdminNotificationsTab();
                break;
        }
    };

    async function loadAdminFilesTab() {
        const snapshot = await filesRef.once('value');
        const allFiles = snapshot.val() ? Object.entries(snapshot.val())
            .map(([id, data]) => ({ id, ...data }))
            .sort((a, b) => b.created_at - a.created_at) : [];

        const content = document.getElementById('adminContent');
        content.innerHTML = `
            <div class="admin-section">
                <div class="admin-section-header">
                    <h2 class="admin-section-title">
                        <i class="fas fa-file" style="color: var(--primary);"></i>
                        Manage Files
                    </h2>
                </div>

                <div style="overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Uploaded By</th>
                                <th>Status</th>
                                <th>Downloads</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allFiles.map(file => `
                                <tr>
                                    <td>${file.title || 'Untitled'}</td>
                                    <td>${file.uploadedByEmail || 'Unknown'}</td>
                                    <td>
                                        <span class="admin-status-badge status-${file.status || 'pending'}">
                                            ${file.status || 'pending'}
                                        </span>
                                    </td>
                                    <td>${file.total_downloads || 0}</td>
                                    <td>${timeAgoShort(file.created_at)}</td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="admin-action-btn approve" onclick="approveFile('${file.id}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="admin-action-btn reject" onclick="rejectFile('${file.id}')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button class="admin-action-btn delete" onclick="deleteFile('${file.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <button class="admin-action-btn edit" onclick="openEditFileModal('${file.id}', 'file')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    async function loadAdminBannersTab() {
        const snapshot = await bannersRef.once('value');
        const allBanners = snapshot.val() ? Object.entries(snapshot.val())
            .map(([id, data]) => ({ id, ...data }))
            .sort((a, b) => b.created_at - a.created_at) : [];

        const content = document.getElementById('adminContent');
        content.innerHTML = `
            <div class="admin-section">
                <div class="admin-section-header">
                    <h2 class="admin-section-title">
                        <i class="fas fa-image" style="color: var(--primary);"></i>
                        Manage Banners
                    </h2>
                </div>

                <div style="overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Thumbnail</th>
                                <th>Downloads</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allBanners.map(banner => `
                                <tr>
                                    <td>${banner.title || 'Untitled'}</td>
                                    <td><img src="${banner.thumbnail_url}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 8px;" onerror="this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='"></td>
                                    <td>${banner.total_downloads || 0}</td>
                                    <td>${timeAgoShort(banner.created_at)}</td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="admin-action-btn delete" onclick="deleteBanner('${banner.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <button class="admin-action-btn edit" onclick="openEditFileModal('${banner.id}', 'banner')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    async function loadAdminUsersTab() {
        const snapshot = await usersRef.once('value');
        const allUsers = snapshot.val() ? Object.entries(snapshot.val())
            .map(([id, data]) => ({ uid: id, ...data }))
            .sort((a, b) => b.created_at - a.created_at) : [];

        const adminSnapshot = await adminsRef.once('value');
        const adminUsers = adminSnapshot.val() ? Object.keys(adminSnapshot.val()) : [];

        const content = document.getElementById('adminContent');
        content.innerHTML = `
            <div class="admin-section">
                <div class="admin-section-header">
                    <h2 class="admin-section-title">
                        <i class="fas fa-users" style="color: var(--primary);"></i>
                        Manage Users
                    </h2>
                </div>

                <div style="overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Username</th>
                                <th>Status</th>
                                <th>Ads</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allUsers.map(user => `
                                <tr>
                                    <td>${user.fullname || 'N/A'}</td>
                                    <td>${user.email || 'N/A'}</td>
                                    <td>${user.username || 'N/A'}</td>
                                    <td>
                                        <span class="admin-status-badge status-${user.isAccountActive ? 'approved' : 'rejected'}">
                                            ${user.isAccountActive ? 'Active' : 'Inactive'}
                                        </span>
                                    </td>
                                    <td>${user.adsWatched || 0}</td>
                                    <td>${timeAgoShort(user.created_at)}</td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="admin-action-btn ${adminUsers.includes(user.uid) ? 'reject' : 'approve'}" 
                                                    onclick="toggleAdmin('${user.uid}')">
                                                <i class="fas fa-crown"></i>
                                            </button>
                                            <button class="admin-action-btn ${user.isAccountActive ? 'reject' : 'approve'}" 
                                                    onclick="toggleUserStatus('${user.uid}')">
                                                <i class="fas ${user.isAccountActive ? 'fa-ban' : 'fa-check'}"></i>
                                            </button>
                                            <button class="admin-action-btn delete" onclick="deleteUser('${user.uid}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    function loadAdminNotificationsTab() {
        const content = document.getElementById('adminContent');
        content.innerHTML = `
            <div class="admin-section">
                <div class="admin-section-header">
                    <h2 class="admin-section-title">
                        <i class="fas fa-bell" style="color: var(--primary);"></i>
                        Send Notification
                    </h2>
                </div>

                <div class="notification-sender">
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" id="notifTitle" class="form-control" placeholder="Notification title">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Description (Markdown supported)</label>
                        <textarea id="notifDesc" class="form-control" rows="4" placeholder="Write your notification..."></textarea>
                        <div class="markdown-preview" id="markdownPreview"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Target</label>
                        <select id="notifTarget" class="form-control">
                            <option value="all">All Users</option>
                            <option value="admins">Admins Only</option>
                            <option value="users">Regular Users</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" onclick="sendNotification()">
                        <i class="fas fa-paper-plane"></i> Send Notification
                    </button>
                </div>
            </div>
        `;
    }

    window.approveFile = async (fileId) => {
        if (!confirm('Approve this file?')) return;
        await filesRef.child(fileId).update({ status: 'approved' });
        loadAdminFilesTab();
    };

    window.rejectFile = async (fileId) => {
        if (!confirm('Reject this file?')) return;
        await filesRef.child(fileId).update({ status: 'rejected' });
        loadAdminFilesTab();
    };

    window.deleteFile = async (fileId) => {
        if (!confirm('Delete this file permanently?')) return;
        await filesRef.child(fileId).remove();
        loadAdminFilesTab();
    };

    window.deleteBanner = async (bannerId) => {
        if (!confirm('Delete this banner permanently?')) return;
        await bannersRef.child(bannerId).remove();
        loadAdminBannersTab();
    };

    window.toggleAdmin = async (userId) => {
        const adminSnapshot = await adminsRef.child(userId).once('value');
        if (adminSnapshot.exists()) {
            await adminsRef.child(userId).remove();
        } else {
            await adminsRef.child(userId).set(true);
        }
        loadAdminUsersTab();
    };

    window.toggleUserStatus = async (userId) => {
        const userSnapshot = await usersRef.child(userId).once('value');
        const currentStatus = userSnapshot.val().isAccountActive;
        await usersRef.child(userId).update({ isAccountActive: !currentStatus });
        loadAdminUsersTab();
    };

    window.deleteUser = async (userId) => {
        if (!confirm('Delete this user permanently?')) return;
        try {
            await usersRef.child(userId).remove();
            await adminsRef.child(userId).remove();
            loadAdminUsersTab();
        } catch (error) {
            console.error(error);
        }
    };

    window.sendNotification = async () => {
        const title = document.getElementById('notifTitle').value;
        const desc = document.getElementById('notifDesc').value;
        const target = document.getElementById('notifTarget').value;

        if (!title || !desc) {
            alert('Please fill all fields');
            return;
        }

        await notificationsRef.push({
            title: title,
            decs: desc,
            target_uid: target === 'all' ? 'all' : target,
            is_read: false,
            created_at: Date.now()
        });

        document.getElementById('notifTitle').value = '';
        document.getElementById('notifDesc').value = '';
        alert('Notification sent!');
    };

    function showAlert(elementId, message, type) {
        const alert = document.getElementById(elementId);
        alert.textContent = message;
        alert.className = `alert alert-${type}`;
        alert.classList.remove('hidden');
        setTimeout(() => alert.classList.add('hidden'), 3000);
    }

    // Initialize
    initTheme();

    // Check for short links on load and hash change
    window.addEventListener('load', checkForShortLink);
    window.addEventListener('hashchange', checkForShortLink);

    // Router
    window.addEventListener('popstate', router);
    router();
</script>
</body>
</html>
